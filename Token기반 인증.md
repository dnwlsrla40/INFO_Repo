Token 기반 인증


Stateful 서버

클라이언트에서 요청을 받을 때 마다, 클라이언트의 상태를 계속해서 유지하고 이 정보를 서비스 제공에 이용 

ex) 세션을 유지하는 웹서버
    1) 유저 로그인
    2) 세션에 로그인 되었다고 저장
    3) 서비스 제공 시 이 데이터 사용

여기서 session은 서버 컴퓨터의 메모리에 담거나 데이터베이스 시스템에 담는다.

Stateless 서버

상태를 유지하지 않는 서버로 클라이언트측에서 들어오는 요청만으로 작업을 처리

클라이언트와 서버의 연결고리가 없기 때문에 서버의 확장성이 높음

모바일 어플리케이션에 적합하다

Android/IOS 모바일 어플리케이션을 개발 해야 한다면 안전한 API를 만들기 위해선 쿠키같은 인증 시스템은 쿠키 컨테이너를 사용해야 해서 이상적이지 않다. 토큰 기반 인증을 도입하면, 더욱 간단하게 번거로운을 해결 할 수 있다.

인증정보를 다른 어플리케이션으로 전달

대표적인 예제로 OAuth(다른 소셜 계정들을 통한 로그인)

보안성이 높아진다.

왜 토큰을 사용하게 되었을까?

과거의 인증시스템

서버 기반 인증

기존의 인증 시스템에서는 서버측에서 유저들의 정보를 기억하고 있어야 한다.

주로 이 세션을 유지하기 위해 메모리/디스크/데이터베이스시스템에 담아둠

일반적인 서버의 흐름

![일반적인 서버의 흐름](/picture/서버_기반_인증_흐름.JPG)

서버 기반 인증의 문제점

1. 세션

로그인 중인 유저의 수가 늘어난다면 세션을 저장해야 할 서버의 램이 과부하가 걸리며 데이터베이스의 성능에 무리를 줄 수 있다.

2. 확장성 (Sacle-out)의 어려움

세션을 사용하면 서버를 확장하는 것이 어려워진다. 여기서 확장이란, 사양을 업그레이드 하는 것이 아니라, 더 많은 트래픽을 감당하기 위해 여러개의 프로세스를 돌리거나, 여러대의 서버 컴퓨터를 추가하는 것
   
3. CORS(Cross-Origin Resource Sharing)

웹 어플리케이션에서 세션을 관리 할 때 자주 사용되는 쿠키는 단일 도메인 및 서브 도메인에서만 작동하도록 설계되어 있어 여러 도메인에서 관리하는 것이 번거로움

토큰 기반 시스템의 작동 원리

토큰 기반 시스템은 stateless하다. 즉, 상태유지를 하지 않아 인증정보를 서버나 세션에 담아두지 않는다.

1) 유저가 아이디와 비밀버호로 로그인을 한다.
2) 서버측에서 해당 계정을 검증
3) 검증되면, signed 토큰 발급
4) 클라이언트 측에서 토큰을 저장해두고, 서버에 요청 할 때마다, 토큰을 함께 서버에 전달
5) 서버는 토큰을 검증하고 응답

![토큰 기반 서버의 흐름](/picture/토큰_기반_인증_흐름.JPG)

토큰의 장점

1. stateless와 scale-out 확장성

토큰은 클라이언트 사이드에 저장하기 때문에 stateless하며 이로 인한 서버의 scale-out이 편하다.

2. 보안성
   
클라이언트가 서버에 요청을 보낼 때 더 이상 쿠키를 전달하지 않음으로 쿠키를 사용할 때 생기는 취약점이 사라진다. 하지만 토큰을 사용하는 환경에도 취약점은 존재한다.

3. 로그인 정보의 확장성
   
토큰을 사용하여 다른 서비스에서도 권한을 공유 할 수 있다.

4. 여러 플랫폼 및 도메인

토큰을 사용하면 어떤 디바이스에서도, 도메인에서도 토큰만 유효하다면 요청이 정상적으로 처리가능하다. 서버츩에서 어플리케이션 응답부분에 아래와 같은 헤더만 포함시켜주면 된다.

```
Access-Control-Allow-Origin:
```


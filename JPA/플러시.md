# 플러시

플러시는 영속성 컨텍스트의 변경내용을 데이터베이스에 반영한다는 뜻이다.

즉, 영속성 컨텍스트의 내용과 DB의 내용을 맞추는 것(동기화)이다.

트랜잭션이라는 작업 단위 기준으로 하기 때문에 가능 -> 커밋 직전에만 데이터 동기화가 되면 됨

## 플러시 발생 시 이루어 지는 것들

1. 변경 감지(Dirty Checking)

2. 수정된 엔티티 쓰기 지연 SQL 저장소에 등록

3. 쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송(등록, 수정, 삭제 쿼리)(commit()은 DB에 전송 후에 함)

위 처럼 쓰기 지연 SQL 저장소의 내용이 전달 될 뿐 1차 캐시가 초기화 되거나 하는 일은 일어나지 않는다.

## 영속성 컨텍스트를 플러시하는 방법

1. em.flush() - 직접 호출( 쿼리가 날라가는 것을 직접 보고 싶은 경우, DB에 미리 반영하고 싶은 경우)

2. 트랜잭션 커밋(transaction.commit()) - 플러시 자동 호출

3. JPQL 쿼리 실행 - 플러시 자동 호출 (해당 JPQL에서 위의 em.persist()한 객체를 필요로 하는 경우를 위해)

## 플러시 모드 옵션

```
em.setFlushMode(FlushModeType.COMMIT or FlushModeType.AUTO)
```

- FlushModeType.AUTO : 커밋이나 쿼리를 실행할 때 플러시(기본 값, 권장)
- FlushModeType.COMMIT : 커밋할 때만 플러시